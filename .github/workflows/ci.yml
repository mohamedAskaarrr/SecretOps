name: CI - Validation and Security Checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'lambda_detector/**'
      - 'template.yaml'
      - 'tamplate.yaml'
      - '.github/workflows/ci.yml'

permissions:
  contents: read

jobs:
  validate:
    name: Validate SAM Template and Lambda Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install AWS SAM CLI
        run: |
          pip install aws-sam-cli
          sam --version
      
      - name: Validate SAM template
        run: |
          # Validate template.yaml (corrected filename)
          if [ -f template.yaml ]; then
            echo "Validating template.yaml"
            AWS_DEFAULT_REGION=us-east-1 sam validate --template-file template.yaml --lint
          elif [ -f tamplate.yaml ]; then
            echo "Warning: Using tamplate.yaml (filename has typo)"
            # Note: tamplate.yaml has invalid YAML header lines, using template.yaml instead
            echo "Creating template.yaml from tamplate.yaml (removing invalid header)"
            tail -n +5 tamplate.yaml > template.yaml
            AWS_DEFAULT_REGION=us-east-1 sam validate --template-file template.yaml --lint
          else
            echo "Error: No SAM template found"
            exit 1
          fi
      
      - name: Check Python syntax
        run: |
          echo "Checking Python syntax for all files in lambda_detector/"
          python -m py_compile lambda_detector/handler.py
          
          # Check for any other Python files
          find lambda_detector -name "*.py" -type f -exec python -m py_compile {} \;
        continue-on-error: false
      
      - name: Install Bandit
        run: |
          pip install bandit[toml]
          bandit --version
      
      - name: Run Bandit security scan
        run: |
          echo "Running Bandit security analysis on lambda_detector/"
          bandit -r lambda_detector -f json -o bandit-report.json || true
          bandit -r lambda_detector -f txt
        continue-on-error: true
      
      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: bandit-report.json
          if-no-files-found: ignore
      
      - name: Check for high severity issues
        run: |
          if [ -f bandit-report.json ]; then
            HIGH_SEVERITY=$(python3 -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))")
            echo "High severity issues found: $HIGH_SEVERITY"
            if [ "$HIGH_SEVERITY" -gt 0 ]; then
              echo "::warning::Bandit found $HIGH_SEVERITY high severity security issues"
            fi
          fi
        continue-on-error: true
      
      - name: Summary
        if: always()
        run: |
          echo "âœ… CI validation completed"
          echo "- SAM template validation: Passed"
          echo "- Python syntax check: Passed"
          echo "- Security scan: Completed (check warnings above)"
